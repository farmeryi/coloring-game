<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canvas 繪圖工具 RWD 修正版</title>
<style>
  body { 
    margin: 0; 
    padding: 0;
    font-family: Arial, sans-serif; 
    background: #f0f0f0;
    min-height: 100vh;
    overflow-x: hidden;
  }
  
  .header {
    text-align: center;
    padding: 10px 0;
    background: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    z-index: 10;
    width: 100vw;
    box-sizing: border-box;
  }
  
  .controls { 
    margin: 10px 0; 
    padding: 0 10px;
    display: flex; 
    flex-wrap: wrap; 
    justify-content: center; 
    gap: 5px;
    width: 100%;
    box-sizing: border-box;
  }
  
  .color-btn { 
    width: 30px; 
    height: 30px; 
    display: inline-block; 
    cursor: pointer; 
    border: 1px solid #ccc; 
    border-radius: 3px;
  }
  
  .main-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: calc(100vh - 200px);
    padding: 20px 0 50px 0;
    box-sizing: border-box;
  }
  
  #canvasContainer { 
    position: relative;
    width: 100vw;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
  }
  
  canvas { 
    border: 2px solid #333;
    position: absolute; 
    top: 0; 
    left: 0; 
    touch-action: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border-radius: 5px;
  }
  
  .upload-section { 
    margin: 10px 0; 
    padding: 10px; 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    width: 100%;
    box-sizing: border-box;
  }
  
  .upload-btn { 
    margin: 5px; 
    padding: 8px 15px; 
    background: #4CAF50; 
    color: white; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer;
    font-size: 14px;
  }
  
  .upload-btn:hover { 
    background: #45a049; 
  }
  
  .upload-btn.bg { 
    background: #2196F3; 
  }
  
  .upload-btn.bg:hover { 
    background: #0b7dda; 
  }
  
  .layer-info { 
    margin: 5px; 
    font-size: 12px; 
    color: #666; 
  }
  
  .control-btn {
    margin: 5px;
    padding: 8px 12px;
    background: #555;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .control-btn:hover {
    background: #333;
  }
  
  .slider-container {
    display: flex;
    align-items: center;
    margin: 5px;
    gap: 10px;
  }
  
  .slider-container input[type="range"] {
    width: 100px;
  }
  
  @media (max-width: 768px) { 
    .color-btn { width: 25px; height: 25px; }
    .main-container {
      padding: 15px 0 30px 0;
    }
    .upload-btn, .control-btn {
      font-size: 12px;
      padding: 6px 10px;
    }
  }
  
  @media (max-width: 480px) {
    .controls {
      margin: 5px 0;
      padding: 0 5px;
      gap: 3px;
    }
    .upload-section {
      margin: 5px 0;
      padding: 8px;
    }
    .main-container {
      padding: 10px 0 20px 0;
    }
  }
</style>
</head>
<body>

<div class="header">
  <h2>Canvas 繪圖工具</h2>
  
  <div class="upload-section">
    <div class="layer-info">圖層順序：背景圖 → 畫筆繪圖 → 去背圖（最上層）</div>
    <input type="file" id="uploadBg" accept="image/*" style="display:none" onchange="uploadBackgroundImage(event)">
    <button class="upload-btn bg" onclick="document.getElementById('uploadBg').click()">上傳背景圖</button>
    
    <input type="file" id="uploadOverlay" accept="image/*" style="display:none" onchange="uploadOverlayImage(event)">
    <button class="upload-btn" onclick="document.getElementById('uploadOverlay').click()">上傳去背圖（推薦PNG）</button>
    
    <button class="upload-btn" onclick="clearBackground()">清除背景</button>
    <button class="upload-btn" onclick="clearOverlay()">清除去背圖</button>
  </div>

  <div class="controls" id="colorPalette"></div>
  <div class="controls">
    <button class="control-btn" onclick="setEraser()">橡皮擦</button>
    <div class="slider-container">
      <label>粗細：</label>
      <input type="range" id="lineWidth" min="1" max="20" value="3" onchange="changeLineWidth(this.value)">
      <span id="lineWidthValue">3</span>
    </div>
    <button class="control-btn" onclick="undo()">復原</button>
    <button class="control-btn" onclick="redo()">重做</button>
    <button class="control-btn" onclick="clearDraw()">清除畫筆</button>
    <button class="control-btn" onclick="downloadCanvas()">下載合成圖</button>
  </div>
</div>

<div class="main-container">
  <div id="canvasContainer">
    <canvas id="bgCanvas"></canvas>
    <canvas id="drawCanvas"></canvas>
    <canvas id="overlayCanvas"></canvas>
  </div>
</div>

<script>
const bgCanvas = document.getElementById("bgCanvas");
const drawCanvas = document.getElementById("drawCanvas");
const overlayCanvas = document.getElementById("overlayCanvas");

const bgCtx = bgCanvas.getContext("2d");
const ctx = drawCanvas.getContext("2d");
const overlayCtx = overlayCanvas.getContext("2d");

let drawing = false;
let currentColor = "black";
let lineWidth = 3;
let isEraser = false;
let history = [];
let redoHistory = [];
let lastPos = {x:0,y:0};
let bgImage = null;
let overlayImage = null;

// 響應式畫布調整
function resizeCanvas(){
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  let width, height;
  
  if (bgImage) {
    // 有背景圖片時，根據圖片比例調整
    const imgAspect = bgImage.width / bgImage.height;
    
    // 寬度設為視窗寬度
    width = viewportWidth;
    height = width / imgAspect;
    
    // 如果高度超過視窗高度的80%，則調整
    const maxHeight = viewportHeight * 0.8;
    if (height > maxHeight) {
      height = maxHeight;
      width = height * imgAspect;
    }
  } else {
    // 沒有背景圖片時，使用視窗寬度和4:3比例
    width = viewportWidth;
    height = width * 0.75; // 4:3比例
    
    // 確保高度不超過視窗的80%
    const maxHeight = viewportHeight * 0.8;
    if (height > maxHeight) {
      height = maxHeight;
      width = height * (4/3);
    }
  }
  
  [bgCanvas, drawCanvas, overlayCanvas].forEach(c => {
    c.width = width;
    c.height = height;
    c.style.width = width + 'px';
    c.style.height = height + 'px';
  });
  
  // 設置白色預設背景
  bgCtx.fillStyle = '#FFFFFF';
  bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
  
  redrawBackground();
  redrawDrawLayer();
  redrawOverlay();
}

window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', function() {
  setTimeout(resizeCanvas, 100);
});

// 觸控與滑鼠事件
function getPos(e){
  const rect = drawCanvas.getBoundingClientRect();
  let clientX, clientY;
  if(e.touches){ clientX=e.touches[0].clientX; clientY=e.touches[0].clientY;}
  else{ clientX=e.clientX; clientY=e.clientY;}
  return { x:(clientX-rect.left)*(drawCanvas.width/rect.width),
           y:(clientY-rect.top)*(drawCanvas.height/rect.height)};
}

function startDraw(e){
  e.preventDefault();
  drawing = true;
  lastPos = getPos(e);
  ctx.beginPath();
  ctx.moveTo(lastPos.x,lastPos.y);
}

function draw(e){
  if(!drawing) return;
  e.preventDefault();
  const pos = getPos(e);
  ctx.lineWidth = lineWidth;
  ctx.lineCap = "round";
  ctx.strokeStyle = currentColor;
  ctx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
  ctx.beginPath();
  ctx.moveTo(lastPos.x,lastPos.y);
  ctx.lineTo(pos.x,pos.y);
  ctx.stroke();
  lastPos = pos;
}

function stopDraw(){
  if(!drawing) return;
  drawing=false;
  ctx.closePath();
  saveHistory();
}

// 事件監聽器綁定
drawCanvas.addEventListener("mousedown", startDraw);
drawCanvas.addEventListener("mousemove", draw);
drawCanvas.addEventListener("mouseup", stopDraw);
drawCanvas.addEventListener("mouseout", stopDraw);
drawCanvas.addEventListener("touchstart", startDraw, {passive:false});
drawCanvas.addEventListener("touchmove", draw, {passive:false});
drawCanvas.addEventListener("touchend", stopDraw, {passive:false});

overlayCanvas.addEventListener("mousedown", startDraw);
overlayCanvas.addEventListener("mousemove", draw);
overlayCanvas.addEventListener("mouseup", stopDraw);
overlayCanvas.addEventListener("mouseout", stopDraw);
overlayCanvas.addEventListener("touchstart", startDraw, {passive:false});
overlayCanvas.addEventListener("touchmove", draw, {passive:false});
overlayCanvas.addEventListener("touchend", stopDraw, {passive:false});

// 顏色與橡皮擦
function setColor(color){ currentColor=color; isEraser=false; }
function setEraser(){ isEraser=true; }

// 粗細調整
function changeLineWidth(value){ 
  lineWidth = value; 
  document.getElementById('lineWidthValue').textContent = value;
}

// 清除畫筆層
function clearDraw(){
  ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
  saveHistory();
}

// 歷史紀錄
function saveHistory(){
  const imgData = drawCanvas.toDataURL();
  history.push(imgData);
  redoHistory = [];
  if(history.length > 50) history.shift();
}

// 復原
function undo(){
  if(history.length>1){
    redoHistory.push(history.pop());
    const img = new Image();
    img.src = history[history.length-1];
    img.onload = ()=>{
      ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      ctx.drawImage(img,0,0,drawCanvas.width,drawCanvas.height);
    }
  }
}

// 重做
function redo(){
  if(redoHistory.length>0){
    const imgData = redoHistory.pop();
    const img = new Image();
    img.src = imgData;
    img.onload = ()=>{
      ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      ctx.drawImage(img,0,0,drawCanvas.width,drawCanvas.height);
    }
    history.push(imgData);
  }
}

// 上傳背景圖片
function uploadBackgroundImage(event){
  const file = event.target.files[0];
  if(!file) return;
  
  if(!file.type.startsWith('image/')){
    alert('請選擇圖片文件！');
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      bgImage = img;
      resizeCanvas(); // 重新調整畫布尺寸以配合圖片
    };
    img.onerror = function() {
      alert('圖片載入失敗，請檢查文件格式！');
    };
    img.src = e.target.result;
  };
  reader.onerror = function() {
    alert('文件讀取失敗！');
  };
  reader.readAsDataURL(file);
  
  event.target.value = '';
}

// 上傳覆蓋圖片
function uploadOverlayImage(event){
  const file = event.target.files[0];
  if(!file) return;
  
  if(!file.type.startsWith('image/')){
    alert('請上傳圖片文件（建議使用 PNG 格式以保持透明效果）！');
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      overlayImage = img;
      redrawOverlay();
    };
    img.onerror = function() {
      alert('圖片載入失敗，請檢查文件格式！');
    };
    img.src = e.target.result;
  };
  reader.onerror = function() {
    alert('文件讀取失敗！');
  };
  reader.readAsDataURL(file);
  
  event.target.value = '';
}

// 清除背景
function clearBackground(){
  bgImage = null;
  resizeCanvas(); // 重新調整到預設尺寸
}

// 清除覆蓋層
function clearOverlay(){
  overlayImage = null;
  redrawOverlay();
}

// 重新繪製背景
function redrawBackground(){
  // 先填充白色背景
  bgCtx.fillStyle = '#FFFFFF';
  bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
  
  if(bgImage) {
    // 將圖片完全填滿畫布，保持比例
    try {
      bgCtx.drawImage(bgImage, 0, 0, bgCanvas.width, bgCanvas.height);
    } catch(e) {
      alert('繪製背景圖片時發生錯誤！');
    }
  }
}

// 重新繪製畫筆層
function redrawDrawLayer(){
  if(history.length>0){
    const img = new Image();
    img.src = history[history.length-1];
    img.onload = ()=>{
      ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      ctx.drawImage(img,0,0,drawCanvas.width,drawCanvas.height);
    }
  }else{
    ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
  }
}

// 重新繪製覆蓋層
function redrawOverlay(){
  overlayCtx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
  
  if(overlayImage) {
    try {
      // 保持原始尺寸和透明度，填滿整個畫布
      overlayCtx.drawImage(overlayImage, 0, 0, overlayCanvas.width, overlayCanvas.height);
    } catch(e) {
      alert('繪製覆蓋圖片時發生錯誤！');
    }
  }
}

// 下載合併圖片
function downloadCanvas(){
  const tempCanvas = document.createElement("canvas");
  tempCanvas.width = drawCanvas.width;
  tempCanvas.height = drawCanvas.height;
  const tempCtx = tempCanvas.getContext("2d");
  
  // 按順序合併所有圖層
  tempCtx.drawImage(bgCanvas,0,0);
  tempCtx.drawImage(drawCanvas,0,0);
  tempCtx.drawImage(overlayCanvas,0,0);
  
  const link = document.createElement("a");
  link.download = "canvas_" + new Date().getTime() + ".png";
  link.href = tempCanvas.toDataURL("image/png");
  link.click();
}

// 36色調色盤
const colors=[
"#000000","#808080","#C0C0C0","#FFFFFF","#800000","#FF0000",
"#808000","#FFFF00","#008000","#00FF00","#008080","#00FFFF",
"#000080","#0000FF","#800080","#FF00FF","#A52A2A","#FFA500",
"#B8860B","#FFD700","#2E8B57","#90EE90","#20B2AA","#40E0D0",
"#4169E1","#87CEEB","#6A5ACD","#9370DB","#FF1493","#FF69B4",
"#CD5C5C","#F08080","#708090","#D3D3D3","#F5F5DC","#FFE4C4"];

const palette = document.getElementById("colorPalette");
colors.forEach(c=>{
  const btn = document.createElement("div");
  btn.className="color-btn";
  btn.style.backgroundColor=c;
  btn.onclick=()=>setColor(c);
  btn.title = c;
  palette.appendChild(btn);
});

// 初始化
resizeCanvas();
saveHistory();

// 防止頁面滾動
document.addEventListener('touchmove', function(e) {
  if(e.target.tagName === 'CANVAS') {
    e.preventDefault();
  }
}, {passive: false});

</script>

</body>
</html>
