<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â°óËâ≤ÈÅäÊà≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: auto;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 10px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
        }

        .upload-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .file-input-wrapper:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .demo-btn {
            background: #FF6B6B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .demo-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
        }

        .brush-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brush-size-slider {
            width: 100px;
            height: 5px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .brush-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .brush-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brush-dot {
            border-radius: 50%;
            background: currentColor;
            transition: all 0.3s ease;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .clear-btn {
            background: #ff6b6b;
        }

        .clear-btn:hover {
            background: #ff5252;
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: 15px;
            min-height: 0;
        }

        .color-palette {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            width: 280px;
            max-height: fit-content;
        }

        .palette-title {
            color: white;
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .color-item {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .color-item.selected {
            border-color: white;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(255,255,255,0.8);
        }

        .eraser {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .canvas-wrapper {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #drawingCanvas, #lineCanvas {
            display: block;
            cursor: crosshair;
        }

        .placeholder {
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            font-size: 18px;
            padding: 40px;
        }

        /* ÊâãÊ©üÁâàÊ®£Âºè */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .upload-section {
                justify-content: center;
            }

            .controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .main-content {
                flex-direction: column;
                gap: 10px;
            }

            .color-palette {
                width: 100%;
                order: 2;
            }

            .canvas-container {
                order: 1;
                min-height: 60vh;
            }

            .color-grid {
                grid-template-columns: repeat(9, 1fr);
                gap: 6px;
            }

            .color-item {
                width: 30px;
                height: 30px;
            }

            .brush-size-control {
                flex: 1;
                justify-content: center;
            }
        }

        /* Ëá™ÂÆöÁæ©Ê∏∏Ê®ô */
        .canvas-wrapper.drawing {
            cursor: none;
        }

        .cursor-dot {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid white;
            pointer-events: none;
            z-index: 1000;
            transform: translate(-50%, -50%);
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="imageUpload" accept="image/*">
                    ‰∏äÂÇ≥ÂúñÁâá
                </div>
                <button class="demo-btn" id="demoBtn">ËºâÂÖ•Á§∫ÁØÑÂúñÁâá</button>
            </div>
            
            <div class="controls">
                <div class="control-group brush-size-control">
                    <span style="color: white; font-size: 14px;">Á≠ÜÂà∑:</span>
                    <input type="range" id="brushSize" class="brush-size-slider" min="1" max="50" value="5">
                    <div class="brush-preview">
                        <div class="brush-dot" id="brushPreview"></div>
                    </div>
                </div>
                
                <button class="action-btn" id="undoBtn" disabled>‚Ü∂ Âæ©Âéü</button>
                <button class="action-btn" id="redoBtn" disabled>‚Ü∑ ÈáçÂÅö</button>
                <button class="action-btn clear-btn" id="clearBtn">üóëÔ∏è Ê∏ÖÁ©∫</button>
            </div>
        </div>

        <div class="main-content">
            <div class="color-palette">
                <div class="palette-title">ÈÅ∏ÊìáÈ°èËâ≤</div>
                <div class="color-grid" id="colorGrid">
                    <!-- È°èËâ≤ÊúÉÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
                </div>
            </div>

            <div class="canvas-container">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <div class="placeholder">
                        Ë´ã‰∏äÂÇ≥ÂúñÁâáÊàñÈªûÊìä„ÄåËºâÂÖ•Á§∫ÁØÑÂúñÁâá„ÄçÈñãÂßãÂ°óËâ≤
                    </div>
                </div>
                <div class="cursor-dot" id="cursorDot"></div>
            </div>
        </div>
    </div>

    <script>
        class ColoringGame {
            constructor() {
                this.canvas = null;
                this.ctx = null;
                this.lineCanvas = null;
                this.lineCtx = null;
                this.isDrawing = false;
                this.currentColor = '#FF6B6B';
                this.currentSize = 5;
                this.history = [];
                this.historyStep = -1;
                this.isEraser = false;
                
                this.initializeColors();
                this.bindEvents();
                this.updateBrushPreview();
            }

            initializeColors() {
                const colors = [
                    '#FF6B6B', '#FF8E53', '#FF6B9D', '#C44569', '#F8B500', '#FD79A8',
                    '#6C5CE7', '#A29BFE', '#74B9FF', '#0984E3', '#00B894', '#00CEC9',
                    '#55A3FF', '#26A69A', '#66BB6A', '#8BC34A', '#CDDC39', '#FFEB3B',
                    '#FFC107', '#FF9800', '#FF5722', '#795548', '#9E9E9E', '#607D8B',
                    '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4',
                    '#00BCD4', '#009688', '#4CAF50', '#FFFF00', '#FF0000', '#000000'
                ];

                const colorGrid = document.getElementById('colorGrid');
                colorGrid.innerHTML = '';

                colors.forEach((color, index) => {
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    colorItem.style.backgroundColor = color;
                    colorItem.dataset.color = color;
                    
                    if (index === 0) {
                        colorItem.classList.add('selected');
                    }
                    
                    colorItem.addEventListener('click', () => this.selectColor(color, colorItem));
                    colorGrid.appendChild(colorItem);
                });

                // Ê∑ªÂä†Ê©°ÁöÆÊì¶
                const eraser = document.createElement('div');
                eraser.className = 'color-item eraser';
                eraser.textContent = 'Êì¶';
                eraser.addEventListener('click', () => this.selectEraser(eraser));
                colorGrid.appendChild(eraser);
            }

            selectColor(color, element) {
                this.currentColor = color;
                this.isEraser = false;
                this.updateSelectedColor(element);
                this.updateBrushPreview();
            }

            selectEraser(element) {
                this.isEraser = true;
                this.updateSelectedColor(element);
                this.updateBrushPreview();
            }

            updateSelectedColor(selectedElement) {
                document.querySelectorAll('.color-item').forEach(item => {
                    item.classList.remove('selected');
                });
                selectedElement.classList.add('selected');
            }

            updateBrushPreview() {
                const preview = document.getElementById('brushPreview');
                if (preview) {
                    const size = Math.min(this.currentSize, 30);
                    preview.style.width = size + 'px';
                    preview.style.height = size + 'px';
                    preview.style.backgroundColor = this.isEraser ? '#ff6b6b' : this.currentColor;
                }
            }

            bindEvents() {
                // Ê™îÊ°à‰∏äÂÇ≥
                document.getElementById('imageUpload').addEventListener('change', (e) => {
                    this.handleImageUpload(e);
                });

                // Á§∫ÁØÑÂúñÁâáÊåâÈàï
                document.getElementById('demoBtn').addEventListener('click', () => {
                    console.log('ËºâÂÖ•Á§∫ÁØÑÂúñÁâáÊåâÈàïË¢´ÈªûÊìä');
                    this.loadDemoImage();
                });

                // Á≠ÜÂà∑Â§ßÂ∞èÊéßÂà∂
                document.getElementById('brushSize').addEventListener('input', (e) => {
                    console.log('Á≠ÜÂà∑Â§ßÂ∞èÊîπËÆä:', e.target.value);
                    this.currentSize = parseInt(e.target.value);
                    this.updateBrushPreview();
                });

                // ÊéßÂà∂ÊåâÈàï
                document.getElementById('undoBtn').addEventListener('click', () => this.undo());
                document.getElementById('redoBtn').addEventListener('click', () => this.redo());
                document.getElementById('clearBtn').addEventListener('click', () => {
                    console.log('Ê∏ÖÁ©∫ÊåâÈàïË¢´ÈªûÊìä');
                    this.clearCanvas();
                });
            }

            clearCanvas() {
                console.log('Âü∑Ë°åÊ∏ÖÁ©∫ÂäüËÉΩ');
                
                if (!this.ctx || !this.canvas) {
                    console.log('Ê≤íÊúâÁï´Â∏ÉÂèØÊ∏ÖÁ©∫');
                    alert('Ë´ãÂÖàËºâÂÖ•ÂúñÁâáÔºÅ');
                    return;
                }
                
                console.log('Ê∏ÖÁ©∫Áï´Â∏ÉÔºåÂ∞∫ÂØ∏:', this.canvas.width, 'x', this.canvas.height);
                
                // Ê∏ÖÁ©∫Áπ™ÂúñÂ±§
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ÈáçÊñ∞ÂàùÂßãÂåñÊ≠∑Âè≤Ë®òÈåÑ
                this.history = [];
                this.historyStep = -1;
                this.saveState();
                this.updateUndoRedoButtons();
                
                console.log('Ê∏ÖÁ©∫ÂÆåÊàêÔºÅ');
            }

            loadDemoImage() {
                console.log('ÈñãÂßãËºâÂÖ•Á§∫ÁØÑÂúñÁâá');
                
                // ÂâµÂª∫Á§∫ÁØÑÂúñÁâá
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                
                // ÁôΩËâ≤ËÉåÊôØ
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 400, 400);
                
                // Áπ™Ë£ΩËä±ÊúµÁ∑öÁ®ø
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.fillStyle = 'white';
                
                // Ëä±Áì£
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI) / 3;
                    ctx.beginPath();
                    ctx.ellipse(200 + Math.cos(angle) * 40, 200 + Math.sin(angle) * 40, 30, 15, angle, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                }
                
                // Ëä±ÂøÉ
                ctx.beginPath();
                ctx.arc(200, 200, 25, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
                
                // Ëéñ
                ctx.beginPath();
                ctx.moveTo(200, 225);
                ctx.lineTo(200, 350);
                ctx.lineWidth = 5;
                ctx.stroke();
                
                // ËëâÂ≠ê
                ctx.beginPath();
                ctx.ellipse(180, 280, 20, 8, -Math.PI/4, 0, 2 * Math.PI);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.lineWidth = 3;
                ctx.stroke();
                
                ctx.beginPath();
                ctx.ellipse(220, 300, 20, 8, Math.PI/4, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
                
                // ËΩâÊèõÁÇ∫ÂúñÁâá
                const img = new Image();
                img.onload = () => {
                    console.log('Á§∫ÁØÑÂúñÁâáËºâÂÖ•ÊàêÂäü');
                    this.setupCanvas(img);
                };
                img.src = canvas.toDataURL();
            }

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    alert('Ë´ãÈÅ∏ÊìáÂúñÁâáÊ™îÊ°àÔºÅ');
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    alert('ÂúñÁâáÊ™îÊ°àÂ§™Â§ßÔºÅË´ãÈÅ∏ÊìáÂ∞èÊñº10MBÁöÑÂúñÁâá„ÄÇ');
                    return;
                }

                console.log('ÈñãÂßãËºâÂÖ•ÂúñÁâáÔºö', file.name);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        console.log('ÂúñÁâáËºâÂÖ•ÊàêÂäü');
                        this.setupCanvas(img);
                    };
                    img.onerror = () => {
                        alert('ÂúñÁâáËºâÂÖ•Â§±ÊïóÔºåË´ãÂòóË©¶ÂÖ∂‰ªñÂúñÁâáÔºÅ');
                    };
                    img.src = e.target.result;
                };
                reader.onerror = () => {
                    alert('Ê™îÊ°àËÆÄÂèñÂ§±ÊïóÔºÅ');
                };
                reader.readAsDataURL(file);
            }

            setupCanvas(img) {
                console.log('Ë®≠ÁΩÆÁï´Â∏É');
                const canvasWrapper = document.getElementById('canvasWrapper');
                const container = canvasWrapper.parentElement;
                
                // Ë®àÁÆóÁï´Â∏ÉÂ∞∫ÂØ∏
                const containerRect = container.getBoundingClientRect();
                const availableWidth = containerRect.width - 40;
                const availableHeight = containerRect.height - 40;
                
                let canvasWidth, canvasHeight;
                const imgRatio = img.width / img.height;
                const containerRatio = availableWidth / availableHeight;
                
                if (imgRatio > containerRatio) {
                    canvasWidth = Math.min(availableWidth, img.width);
                    canvasHeight = canvasWidth / imgRatio;
                } else {
                    canvasHeight = Math.min(availableHeight, img.height);
                    canvasWidth = canvasHeight * imgRatio;
                }

                console.log('Áï´Â∏ÉÂ∞∫ÂØ∏:', canvasWidth, 'x', canvasHeight);

                // Ê∏ÖÁ©∫ÂÆπÂô®
                canvasWrapper.innerHTML = '';
                canvasWrapper.style.width = canvasWidth + 'px';
                canvasWrapper.style.height = canvasHeight + 'px';
                
                // ËÉåÊôØÁï´Â∏ÉÔºàÁôΩËâ≤Ôºâ
                const backgroundCanvas = document.createElement('canvas');
                backgroundCanvas.width = canvasWidth;
                backgroundCanvas.height = canvasHeight;
                backgroundCanvas.style.position = 'absolute';
                backgroundCanvas.style.top = '0';
                backgroundCanvas.style.left = '0';
                backgroundCanvas.style.zIndex = '1';
                const backgroundCtx = backgroundCanvas.getContext('2d');
                backgroundCtx.fillStyle = 'white';
                backgroundCtx.fillRect(0, 0, canvasWidth, canvasHeight);
                
                // Áπ™ÂúñÁï´Â∏ÉÔºàÂ°óËâ≤Â±§Ôºâ
                this.canvas = document.createElement('canvas');
                this.canvas.id = 'drawingCanvas';
                this.canvas.width = canvasWidth;
                this.canvas.height = canvasHeight;
                this.canvas.style.position = 'absolute';
                this.canvas.style.top = '0';
                this.canvas.style.left = '0';
                this.canvas.style.zIndex = '2';
                
                this.ctx = this.canvas.getContext('2d');
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                // Á∑öÊ¢ùÁï´Â∏ÉÔºàÊúÄ‰∏äÂ±§Ôºâ
                this.lineCanvas = document.createElement('canvas');
                this.lineCanvas.id = 'lineCanvas';
                this.lineCanvas.width = canvasWidth;
                this.lineCanvas.height = canvasHeight;
                this.lineCanvas.style.position = 'absolute';
                this.lineCanvas.style.top = '0';
                this.lineCanvas.style.left = '0';
                this.lineCanvas.style.zIndex = '3';
                this.lineCanvas.style.pointerEvents = 'none';
                
                this.lineCtx = this.lineCanvas.getContext('2d');
                
                // ÊèêÂèñÁ∑öÊ¢ù
                this.extractLines(img, canvasWidth, canvasHeight);
                
                // Âä†ÂÖ•Áï´Â∏É
                canvasWrapper.appendChild(backgroundCanvas);
                canvasWrapper.appendChild(this.canvas);
                canvasWrapper.appendChild(this.lineCanvas);
                
                this.bindCanvasEvents();
                this.saveState();
                
                console.log('Áï´Â∏ÉË®≠ÁΩÆÂÆåÊàê');
            }

            extractLines(img, canvasWidth, canvasHeight) {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvasWidth;
                tempCanvas.height = canvasHeight;
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCtx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                
                const imageData = tempCtx.getImageData(0, 0, canvasWidth, canvasHeight);
                const data = imageData.data;
                const lineData = tempCtx.createImageData(canvasWidth, canvasHeight);
                const linePixels = lineData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const alpha = data[i + 3];
                    const brightness = (r + g + b) / 3;
                    
                    if (brightness < 128 && alpha > 128) {
                        linePixels[i] = r;
                        linePixels[i + 1] = g;
                        linePixels[i + 2] = b;
                        linePixels[i + 3] = alpha;
                    } else {
                        linePixels[i] = 0;
                        linePixels[i + 1] = 0;
                        linePixels[i + 2] = 0;
                        linePixels[i + 3] = 0;
                    }
                }
                
                this.lineCtx.putImageData(lineData, 0, 0);
            }

            bindCanvasEvents() {
                if (!this.canvas) return;

                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseout', () => this.stopDrawing());

                // Ëß∏ÊéßÊîØÊè¥
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousedown', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                });

                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousemove', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                });

                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.stopDrawing();
                });
            }

            getMousePos(e) {
                const rect = this.canvas.getBoundingClientRect();
                const scaleX = this.canvas.width / rect.width;
                const scaleY = this.canvas.height / rect.height;
                
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }

            startDrawing(e) {
                this.isDrawing = true;
                const pos = this.getMousePos(e);
                
                this.ctx.beginPath();
                this.ctx.moveTo(pos.x, pos.y);
                
                if (this.isEraser) {
                    this.ctx.globalCompositeOperation = 'destination-out';
                } else {
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.strokeStyle = this.currentColor;
                }
                
                this.ctx.lineWidth = this.currentSize;
            }

            draw(e) {
                if (!this.isDrawing) return;
                
                const pos = this.getMousePos(e);
                this.ctx.lineTo(pos.x, pos.y);
                this.ctx.stroke();
            }

            stopDrawing() {
                if (this.isDrawing) {
                    this.isDrawing = false;
                    this.saveState();
                }
            }

            saveState() {
                if (!this.canvas) return;
                
                this.historyStep++;
                if (this.historyStep < this.history.length) {
                    this.history.length = this.historyStep;
                }
                this.history.push(this.canvas.toDataURL());
                this.updateUndoRedoButtons();
            }

            undo() {
                if (this.historyStep > 0) {
                    this.historyStep--;
                    this.restoreCanvasState(this.history[this.historyStep]);
                    this.updateUndoRedoButtons();
                }
            }

            redo() {
                if (this.historyStep < this.history.length - 1) {
                    this.historyStep++;
                    this.restoreCanvasState(this.history[this.historyStep]);
                    this.updateUndoRedoButtons();
                }
            }

            restoreCanvasState(dataUrl) {
                const img = new Image();
                img.onload = () => {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.drawImage(img, 0, 0);
                };
                img.src = dataUrl;
            }

            updateUndoRedoButtons() {
                const undoBtn = document.getElementById('undoBtn');
                const redoBtn = document.getElementById('redoBtn');
                
                if (undoBtn) undoBtn.disabled = this.historyStep <= 0;
                if (redoBtn) redoBtn.disabled = this.historyStep >= this.history.length - 1;
            }
        }

        // ÂàùÂßãÂåñÈÅäÊà≤
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ÂàùÂßãÂåñÂ°óËâ≤ÈÅäÊà≤');
            new ColoringGame();
        });

        // Èò≤Ê≠¢È†ÅÈù¢ÊªæÂãï
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.canvas-container')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
